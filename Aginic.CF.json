{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Deploy Aginic code test",

    "Parameters": {
        "KeyNameParameter": {
            "Description": "Key pair name for the EC2 instance",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "VPCIdParameter": {
            "Description": "The VPC id",
            "Type": "AWS::EC2::VPC::Id"
        }
    },

    "Resources": {

        "AginicReactEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": "t2.micro",
                "SecurityGroupIds": [ { "Ref": "AginicReactSecurityGroup" } ],
                "KeyName": { "Ref": "KeyNameParameter" },
                "ImageId": "ami-02769748522663066",
                "Tags": [{"Key": "Name", "Value": "Aginic React Server"}],
                "UserData": { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe \n",
                    "yum install -y git \n",
                    "#\n",
                    "curl -sL https://rpm.nodesource.com/setup_14.x | bash - \n",
                    "yum install -y nodejs \n",
                    "#\n",
                    "su ec2-user -c 'git clone https://github.com/jastupp/aginic-front-end.git /home/ec2-user/front-end' \n",
                    "#\n",
                    "cd /home/ec2-user/front-end \n",
                    "su ec2-user -c 'npm install' \n",
                    "su ec2-user -c 'npm run build' \n",
                    "npm install -g serve \n",
                    "su ec2-user -c 'serve -s build &' \n",
                    "#\n",
                    "su ec2-user -c 'git clone https://github.com/jastupp/aginic-rest-server.git /home/ec2-user/rest-server' \n",
                    "cd /home/ec2-user/rest-server \n",
                    "su ec2-user -c 'npm install' \n",
                    "su ec2-user -c 'npm start &' \n"
                ]]}}
            }
        },

        "AginicReactSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SSH access via port 22",
                "SecurityGroupIngress": [ {
                    "IpProtocol": "tcp",
                    "FromPort": "22",
                    "ToPort": "22",
                    "CidrIp": "0.0.0.0/0"
                }, {
                    "IpProtocol": "tcp",
                    "FromPort": "3000",
                    "ToPort": "3000",
                    "CidrIp": "0.0.0.0/0"
                }, {
                    "IpProtocol": "tcp",
                    "FromPort": "5000",
                    "ToPort": "5000",
                    "CidrIp": "0.0.0.0/0"
                } ],
                "VpcId": { "Ref": "VPCIdParameter" },
                "Tags": [{"Key": "Name", "Value": "Aginic React Seurity Group"}]
            }
        }
    }
}